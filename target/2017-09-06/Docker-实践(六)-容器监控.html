<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      Docker 实践(六)：容器监控 &middot; Tairy's Blog
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">
</head>


  <body>
    <nav class="nav">
      <div class="nav-container">
        <a href="/">
          <h2 class="nav-title">Tairy's Blog</h2>
        </a>
        <ul>
          <li><a href="/about/">About</a></li>
          <li><a href="/">Posts</a></li>
        </ul>
    </div>
  </nav>

    <main>
      <div class="post">
  <div class="post-info">
    <span>Written by&nbsp;</span>Tairy

    
      <br>
      <span>on&nbsp;</span><time datetime="2017-09-06 00:00:00 +0800">September 06, 2017</time>
    
  </div>

  <h1 class="post-title">Docker 实践(六)：容器监控</h1>
  <div class="post-line"></div>

  <h3 id="前言">前言</h3>

<blockquote>
  <p>这两天研究了一下容器监控的问题，配置的过程中网上基本上找不到成型的教程文章，所以这篇文章记录一下，希望能给有需要的人带来帮助。</p>
</blockquote>

<h3 id="监控方案">监控方案</h3>

<p>监控方案我选择了 Zabbix，要实现对每个容器信息的监控，需要 <a href="https://github.com/monitoringartist/zabbix-docker-monitoring">zabbix-docker-monitoring</a> 插件。</p>

<h3 id="配置服务端">配置服务端</h3>

<p>Zabbix 是 C/S 架构，服务端最好能配置在一台独立的宿主机上。</p>

<p>服务端 <em>docker-compose</em> 文件：</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="ss">version: </span><span class="s1">'2'</span>
<span class="ss">services:
  zabbix:
    image: </span><span class="n">monitoringartist</span><span class="o">/</span><span class="n">zabbix</span><span class="o">-</span><span class="n">xxl</span>
    <span class="ss">ports:
      </span><span class="o">-</span> <span class="mi">8080</span><span class="p">:</span><span class="mi">80</span>
      <span class="o">-</span> <span class="mi">10051</span><span class="p">:</span><span class="mi">10051</span>
    <span class="ss">volumes:
      </span><span class="o">-</span> <span class="sr">/etc/</span><span class="n">localtime</span><span class="ss">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">localtime</span><span class="ss">:ro</span>
    <span class="ss">depends_on:
      </span><span class="o">-</span> <span class="n">zabbix</span><span class="p">.</span><span class="nf">db</span>
    <span class="ss">environment:
      </span><span class="no">ZS_DBHost</span><span class="p">:</span> <span class="n">zabbix</span><span class="p">.</span><span class="nf">db</span>
      <span class="no">ZS_DBUser</span><span class="p">:</span> <span class="n">zabbix</span>
      <span class="no">ZS_DBPassword</span><span class="p">:</span> <span class="n">zabbix_password</span>
  <span class="n">zabbix</span><span class="p">.</span><span class="nf">db</span><span class="p">:</span>
    <span class="ss">image: </span><span class="n">monitoringartist</span><span class="o">/</span><span class="n">zabbix</span><span class="o">-</span><span class="n">db</span><span class="o">-</span><span class="n">mariadb</span>
    <span class="ss">volumes:
      </span><span class="o">-</span> <span class="sr">/backups:/</span><span class="n">backups</span>
      <span class="o">-</span> <span class="sr">/etc/</span><span class="n">localtime</span><span class="ss">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">localtime</span><span class="ss">:ro</span>
    <span class="ss">volumes_from:
      </span><span class="o">-</span> <span class="n">zabbix</span><span class="o">-</span><span class="n">db</span><span class="o">-</span><span class="n">storage</span>
    <span class="ss">environment:
      </span><span class="no">MARIADB_USER</span><span class="p">:</span> <span class="n">zabbix</span>
      <span class="no">MARIADB_PASS</span><span class="p">:</span> <span class="n">zabbix_password</span>
  <span class="n">zabbix</span><span class="o">-</span><span class="n">db</span><span class="o">-</span><span class="ss">storage:
    image: </span><span class="n">busybox</span><span class="ss">:latest</span>
    <span class="ss">volumes:
      </span><span class="o">-</span> <span class="sr">/var/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span>
</code></pre>
</div>

<h3 id="容器方式运行-zabbix-agent">容器方式运行 Zabbix-agent</h3>

<p>可以无需在宿主机安装 Zabbix-agent，直接运行官方的容器即可。</p>

<h4 id="运行-zabbix-agent-容器">运行 Zabbix-agent 容器：</h4>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>docker run <span class="se">\</span>
  --name<span class="o">=</span>zabbix-agent-xxl <span class="se">\</span>
  -h <span class="k">$(</span>hostname<span class="k">)</span> <span class="se">\</span>
  -p 10050:10050 <span class="se">\</span>
  -v /:/rootfs <span class="se">\</span>
  -v /var/run:/var/run <span class="se">\</span>
  -e <span class="s2">"ZA_Server=&lt;ZABBIX SERVER IP/DNS NAME&gt;"</span> <span class="se">\</span>
  -d monitoringartist/zabbix-agent-xxl-limited:latest
</code></pre>
</div>

<h4 id="配置容器">配置容器</h4>

<ul>
  <li>修改 <code class="highlighter-rouge">ZA_Server</code>，直接改成服务器 ip。</li>
</ul>

<p>如果想覆盖容器中 agent 的配置变量，可以在 run 的时候使用 <code class="highlighter-rouge">-e ZA_Variable=value</code> 的方法，但是对 AllowRoot, LoadModulePath, LoadModule, LogType 的配置无法覆盖，其中 AllowRoot 的默认值就是 1，参看 <a href="https://github.com/monitoringartist/zabbix-agent-xxl/issues/17">Github Issue</a>。</p>

<h3 id="宿主机直接运行-zabbix-agent">宿主机直接运行 Zabbix-agent</h3>

<p>容器的方式运行 <code class="highlighter-rouge">zabbix-agent</code> 不支持 <code class="highlighter-rouge">docker.xnet</code> 数据的监控，想要监控 <code class="highlighter-rouge">docker.xnet</code> 数据，得直接在宿主机上运行 <code class="highlighter-rouge">zabbix-agent</code>，并加载 <code class="highlighter-rouge">zabbix_module_docker.so</code>，参看 <a href="https://github.com/monitoringartist/zabbix-agent-xxl/issues/17">Github Issue</a>。</p>

<h4 id="1-添加-zabbix-用户和组">1. 添加 zabbix 用户和组</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>groupadd zabbix
useradd -g zabbix zabbix
</code></pre>
</div>

<h4 id="2-编译安装-zabbix-agent">2. 编译安装 zabbix-agent</h4>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>apt-get install -y wget autoconf automake gcc subversion make pkg-config
<span class="nb">cd</span> ~
mkdir zabbix32
<span class="nb">cd </span>zabbix32
svn co svn://svn.zabbix.com/branches/3.2 .
./bootstrap.sh
./configure --enable-agent
make install
</code></pre>
</div>

<h4 id="3-编译-zabbix_module_dockerso">3. 编译 <code class="highlighter-rouge">zabbix\_module\_docker.so</code>:</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>cd ~/zabbix32
mkdir src/modules/zabbix_module_docker
cd src/modules/zabbix_module_docker
wget https://raw.githubusercontent.com/monitoringartist/Zabbix-Docker-Monitoring/master/src/modules/zabbix_module_docker/zabbix_module_docker.c
wget https://raw.githubusercontent.com/monitoringartist/Zabbix-Docker-Monitoring/master/src/modules/zabbix_module_docker/Makefile
make
cp zabbix_module_docker.so /usr/local/lib/zabbix/agent/
</code></pre>
</div>

<h4 id="4-启动-zabbix_agentd">4. 启动 zabbix_agentd</h4>

<p>使用 systemd 管理进程，关于 systemd 可参考 <a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html">阮一峰的网络日志 </a>，创建 <code class="highlighter-rouge">/lib/systemd/system/zabbix-agentd.service</code> 文件：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[Unit]
Description=Zabbix Agent
After=syslog.target
After=network.target

[Service]
Environment="CONFFILE=/usr/local/etc/zabbix_agentd.conf"
Type=forking
Restart=on-failure
PIDFile=/tmp/zabbix_agentd.pid
KillMode=control-group
ExecStart=/usr/local/sbin/zabbix_agentd -c $CONFFILE
ExecStop=/bin/kill -SIGTERM $MAINPID
RestartSec=10s

[Install]
WantedBy=multi-user.target
</code></pre>
</div>

<p>执行下面命令告知 systemctl 如何启动 zabbix-agentd</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>sudo systemctl <span class="nb">enable </span>zabbix-agentd.service
</code></pre>
</div>

<h4 id="5-配置加载项">5. 配置加载项</h4>

<p>修改 zabbix-agentd 配置文件 <code class="highlighter-rouge">/usr/local/etc/zabbix_agentd.conf</code> 中的下面几个参数:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Server=Zabbix-Server-IP
ServerActive=Zabbix-Server-IP
Hostname=Current-Host-Name
Timeout=30
LoadModulePath=/usr/local/lib/zabbix/agent
LoadModule=zabbix_module_docker.so
</code></pre>
</div>

<p>运行下面命令启动 zabbix-agentd</p>

<div class="highlighter-rouge"><pre class="highlight"><code>systemctl start zabbix-agentd.service
</code></pre>
</div>
<h4 id="6-启动失败分析">6. 启动失败分析</h4>

<ul>
  <li>
    <p>如果启动失败，查看 <code class="highlighter-rouge">/tmp/zabbix_agentd.log</code> 文件，如不存在，可手动创建，所属用户为 <code class="highlighter-rouge">zabbix:zabbix</code>。</p>
  </li>
  <li>
    <p>报错：</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>  zabbix_agentd [xxxxx]: cannot attach to existing shared memory: [13] Permission denied
  cannot allocate shared memory for collector
</code></pre>
    </div>
    <p>可能是 <code class="highlighter-rouge">zabbix\_module\_docker.so</code> 编译错误，重新编译一次即可。</p>
  </li>
</ul>

<h3 id="设置监控">设置监控</h3>

<h4 id="1-登录管理系统">1. 登录管理系统</h4>

<p>浏览器访问 <code class="highlighter-rouge">http://ZabbixServerIP:Port</code>，可以看到 zabbix 服务器 web 管理界面，默认登录帐号是 <code class="highlighter-rouge">Admin/zabbix</code> (注意 Admin 首字母大写)。</p>

<p>为了方便操作，可将系统语言设置为中文。</p>

<h4 id="2-导入模板">2. 导入模板</h4>

<ul>
  <li>在 <code class="highlighter-rouge">配置 &gt; 模板</code> 里面导入监控模板：<a href="https://github.com/monitoringartist/grafana-zabbix-dashboards/blob/master/overview-docker/zabbix-template-app-docker.xml">zabbix-template-app-docker.xml</a>。</li>
</ul>

<p><strong>注：模板里有一些已经配置好的监控方案，可以参考取舍。</strong></p>

<h4 id="3-创建主机群组">3. 创建主机群组</h4>

<ul>
  <li>在 <code class="highlighter-rouge">配置 &gt; 主机群组</code> 里创建主机群组，命名为 <code class="highlighter-rouge">Docker Servers</code>。</li>
</ul>

<h4 id="4-创建主机">4. 创建主机</h4>

<ul>
  <li>在 <code class="highlighter-rouge">配置 &gt; 主机</code> 里面创建一个主机。</li>
  <li>群组选择 <code class="highlighter-rouge">Docker Servers</code>。</li>
  <li><code class="highlighter-rouge">agent代理程序的接口</code> 填写要监控的 agent ip。</li>
  <li><code class="highlighter-rouge">模板</code> 选项卡中选择第二步中导入的模板，添加更新。</li>
  <li>在  <code class="highlighter-rouge">监控 &gt; 最新数据</code> 中查看监控数据。</li>
</ul>

<h3 id="参考">参考</h3>

<ul>
  <li><a href="https://www.digitalocean.com/community/tutorials/how-to-install-zabbix-on-ubuntu-configure-it-to-monitor-multiple-vps-servers">How To Install Zabbix on Ubuntu &amp; Configure it to Monitor Multiple VPS Servers</a></li>
  <li><a href="https://hub.docker.com/r/monitoringartist/zabbix-3.0-xxl/">monitoringartist/zabbix-3.0-xxl</a></li>
  <li><a href="https://hub.docker.com/r/monitoringartist/zabbix-agent-xxl-limited/">monitoringartist/zabbix-agent-xxl-limited</a></li>
  <li><a href="https://github.com/monitoringartist/zabbix-docker-monitoring">zabbix-docker-monitoring</a></li>
  <li><a href="http://liubin.org/blog/2016/04/24/how-to-choose-a-docker-monitor-solution/">如何选择Docker监控方案</a></li>
</ul>


</div>

<div class="pagination">
  
    <a href="http://0.0.0.0:4000/2017-09-07/Docker-%E5%AE%9E%E8%B7%B5(%E4%B8%83)-%E6%8F%90%E5%8D%87%E5%B9%B8%E7%A6%8F%E6%84%9F" class="left arrow">&#8592;</a>
  
  
    <a href="http://0.0.0.0:4000/2017-09-05/Docker-%E5%AE%9E%E8%B7%B5(%E4%BA%94)-%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E5%AE%B9%E5%99%A8%E5%8C%96" class="right arrow">&#8594;</a>
  

  <a href="#" class="top">Top</a>
</div>
    </main>

    <footer>
      <span>
        &copy; <time datetime="2017-09-13 09:42:40 +0800">2017</time> . Made with Jekyll using the <a href="https://github.com/chesterhow/tale/">Tale</a> theme.
      </span>
    </footer>
  </body>
</html>
